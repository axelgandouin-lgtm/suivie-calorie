<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suivi Calories & Macros</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#6b7280; --text:#e5e7eb; --accent:#22c55e; }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:var(--bg); color:var(--text)}
    .wrap{max-width:960px; margin:0 auto; padding:24px}
    .card{background:var(--card); border:1px solid #1f2937; border-radius:18px; padding:18px; box-shadow:0 10px 20px rgba(0,0,0,.25)}
    h1{margin:0 0 8px; font-size:26px}
    p.helper{margin:0 0 16px; color:var(--muted); font-size:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    input[type="text"], input[type="number"], select, button{
      height:40px; border-radius:10px; border:1px solid #374151; background:#0b1220; color:var(--text); padding:0 12px;
    }
    input[type="number"]{width:90px}
    button{cursor:pointer}
    button.primary{background:#0b3b22; border-color:#1f5134}
    button.danger{background:#3b0b0b; border-color:#512121}
    table{width:100%; border-collapse:separate; border-spacing:0; margin-top:12px; display:block; overflow-x:auto;}
    th,td{border-bottom:1px solid #1f2937; padding:10px; text-align:center; font-size:14px}
    thead th{position:sticky; top:0; background:#0b1220; z-index:1}
    tbody tr:hover{background:#0b1220}
    .totals{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:16px}
    .stat{background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:12px; text-align:center}
    .stat b{display:block; font-size:18px}
    .actions{display:flex; gap:10px; margin-top:20px; flex-wrap:wrap}
    .actions button{flex:1}
    .bar-container { background:#1f2937; border-radius:10px; height:20px; width:100%; margin:5px 0; overflow:hidden; }
    .bar { height:100%; border-radius:10px; text-align:right; padding-right:5px; color:white; font-size:12px; transition:width 0.5s ease; }
    .bar.prot{background:#3b82f6;}
    .bar.carb{background:#eab308;}
    .bar.fat{background:#f97316;}
    .bar.kcal{background:#22c55e;}
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); overflow:auto; z-index: 1000 }
    .modal-content { background:#111827; margin:5% auto; padding:20px; width:90%; max-width:700px; border-radius:10px; color:var(--text); position : relative; z-index: 1001;}
    .close { float:right; cursor:pointer; font-size:20px; }
    .tabs{display:flex; gap:10px; margin-bottom:12px;}
    .tab-btn{flex:1; padding:10px; cursor:pointer; border:none; border-radius:10px; background:#1f2937; color:var(--text)}
    .tab-btn.active{background:var(--accent); color:#0f172a}
    @media (max-width:640px){
      h1{font-size:22px}
      input[type="number"]{width:80px}
      .totals{grid-template-columns:1fr;}
      table, thead, tbody, th, td, tr { display: block; }
      thead { display: none; }
      tbody tr {
        margin-bottom: 12px; background: #0b1220; padding: 12px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.25);
      }
      tbody td { display: flex; justify-content: space-between; padding: 6px 0; border: none; font-size: 14px; }
      tbody td::before { content: attr(data-label); font-weight: bold; color: var(--muted); margin-right: 8px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Suivi Calories & Macros</h1>
      <p class="helper">Ajoute tes aliments ou plats, puis suis tes macros au quotidien.</p>

      <!-- Formulaire ajout aliment -->
      <div class="row">
        <input type="text" id="f-nom" placeholder="Aliment" />
        <input type="number" id="f-prot" placeholder="Prot (100g)" />
        <input type="number" id="f-carb" placeholder="Glucides (100g)" />
        <input type="number" id="f-fat" placeholder="Lipides (100g)" />
        <input type="number" id="f-kcal" placeholder="Calories (100g)" />
        <select id="f-cat">
          <option value="prot">Protéines</option>
          <option value="carb">Glucides</option>
          <option value="fat">Lipides</option>
        </select>
        <button class="primary" id="btn-add">Ajouter</button>
      </div>

      <!-- Tableau aliments -->
      <table>
        <thead>
          <tr><th>Nom</th><th>Catégorie</th><th>Prot</th><th>Gluc</th><th>Lip</th><th>Kcal</th><th>Qté(g)</th><th>Actions</th></tr>
        </thead>
        <tbody id="foods-body"></tbody>
      </table>

      <!-- Totaux -->
      <div class="totals">
        <div class="stat"><b id="total-prot">0</b> Protéines</div>
        <div class="stat"><b id="total-carb">0</b> Glucides</div>
        <div class="stat"><b id="total-fat">0</b> Lipides</div>
        <div class="stat"><b id="total-kcal">0</b> Calories</div>
      </div>

      <!-- Jauges -->
      <div>
        <div class="bar-container"><div id="bar-prot" class="bar prot"></div></div>
        <div class="bar-container"><div id="bar-carb" class="bar carb"></div></div>
        <div class="bar-container"><div id="bar-fat" class="bar fat"></div></div>
        <div class="bar-container"><div id="bar-kcal" class="bar kcal"></div></div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <button id="btn-clear-custom" class="danger">Effacer mes aliments</button>
      </div>
    </div>
  </div>

  <!-- Modal modifier aliment -->
  <div id="modal-aliment" class="modal">
    <div class="modal-content">
      <span class="close" onclick="document.getElementById('modal-aliment').style.display='none'">&times;</span>
      <h2>Modifier Aliment</h2>
      <input type="text" id="m-nom" placeholder="Nom"><br>
      <input type="number" id="m-prot" placeholder="Protéines"><br>
      <input type="number" id="m-carb" placeholder="Glucides"><br>
      <input type="number" id="m-fat" placeholder="Lipides"><br>
      <input type="number" id="m-kcal" placeholder="Calories"><br>
      <button id="btn-save-aliment" class="primary">Enregistrer</button>
    </div>
  </div>

  <!-- Modal modifier plat -->
  <div id="modal-plat" class="modal">
    <div class="modal-content">
      <span class="close" onclick="document.getElementById('modal-plat').style.display='none'">&times;</span>
      <h2>Modifier Plat</h2>
      <input type="text" id="p-nom" placeholder="Nom du plat"><br>
      <div id="ingredients-list"></div>
      <button id="btn-save-plat" class="primary">Valider</button>
    </div>
  </div>

<script>
const LS_CUSTOM="cm_custom_v2";
const LS_PLATS="cm_plats_v2";
let editIndex=null;

// helpers
function getFoods(){ return JSON.parse(localStorage.getItem(LS_CUSTOM)||"[]"); }
function saveFoods(arr){ localStorage.setItem(LS_CUSTOM, JSON.stringify(arr)); }
function getPlats(){ return JSON.parse(localStorage.getItem(LS_PLATS)||"[]"); }
function savePlats(arr){ localStorage.setItem(LS_PLATS, JSON.stringify(arr)); }

// rendu tableau
function renderTable(){
  const body=document.getElementById("foods-body");
  body.innerHTML="";
  const foods=getFoods();
  foods.forEach((f,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td data-label="Nom">${f.Nom}</td>
      <td data-label="Catégorie">${f.Categorie}</td>
      <td data-label="Prot">${f.Proteines}</td>
      <td data-label="Gluc">${f.Glucides}</td>
      <td data-label="Lip">${f.Lipides}</td>
      <td data-label="Kcal">${f.Calories}</td>
      <td data-label="Qté"><input type="number" min="0" data-index="${i}" class="qte" value="0"/></td>
      <td data-label="Actions"><button onclick="modifierAliment(${i})">✏️</button><button onclick="supprimerAliment(${i})">❌</button></td>`;
    body.appendChild(tr);
  });
  document.querySelectorAll(".qte").forEach(inp=>{
    inp.addEventListener("input",computeTotals);
  });
  computeTotals();
}

// totaux
function computeTotals(){
  let totalProt=0,totalCarb=0,totalFat=0,totalCal=0;
  const foods=getFoods();
  document.querySelectorAll(".qte").forEach(inp=>{
    const idx=parseInt(inp.dataset.index);
    const qty=parseFloat(inp.value)||0;
    if(qty>0){
      const f=foods[idx];
      const ratio=qty/100;
      totalProt+=f.Proteines*ratio;
      totalCarb+=f.Glucides*ratio;
      totalFat+=f.Lipides*ratio;
      totalCal+=f.Calories*ratio;
    }
  });
  document.getElementById("total-prot").textContent=totalProt.toFixed(1);
  document.getElementById("total-carb").textContent=totalCarb.toFixed(1);
  document.getElementById("total-fat").textContent=totalFat.toFixed(1);
  document.getElementById("total-kcal").textContent=totalCal.toFixed(0);

  updateBars(totalProt,totalCarb,totalFat,totalCal);
}
const goals={prot:150,carb:250,fat:70,kcal:2200};
function updateBars(prot,carb,fat,kcal){
  function setBar(id,val,goal){
    const bar=document.getElementById(id);
    let pct=Math.min(100,(val/goal*100));
    bar.style.width=pct+"%";
    bar.textContent=Math.round(val)+"/"+goal;
  }
  setBar("bar-prot",prot,goals.prot);
  setBar("bar-carb",carb,goals.carb);
  setBar("bar-fat",fat,goals.fat);
  setBar("bar-kcal",kcal,goals.kcal);
}

// modif aliments
function modifierAliment(index){
  const foods=getFoods();
  const a=foods[index];
  editIndex=index;
  document.getElementById("m-nom").value=a.Nom;
  document.getElementById("m-prot").value=a.Proteines;
  document.getElementById("m-carb").value=a.Glucides;
  document.getElementById("m-fat").value=a.Lipides;
  document.getElementById("m-kcal").value=a.Calories;
  document.getElementById("modal-aliment").style.display="block";
}
document.getElementById("btn-save-aliment").onclick=()=>{
  const foods=getFoods();
  if(editIndex!==null){
    foods[editIndex]={
      Nom:document.getElementById("m-nom").value.trim(),
      Proteines:parseFloat(document.getElementById("m-prot").value)||0,
      Glucides:parseFloat(document.getElementById("m-carb").value)||0,
      Lipides:parseFloat(document.getElementById("m-fat").value)||0,
      Calories:parseFloat(document.getElementById("m-kcal").value)||0,
      Categorie:foods[editIndex].Categorie
    };
    saveFoods(foods);
    renderTable();
    document.getElementById("modal-aliment").style.display="none";
    editIndex=null;
  }
};
function supprimerAliment(index){
  if(!confirm("Supprimer cet aliment ?")) return;
  let foods=getFoods();
  foods.splice(index,1);
  saveFoods(foods);
  renderTable();
}

// modif plat
function modifierPlat(index){
  let plats=getPlats();
  if(index<0||index>=plats.length)return;
  let plat=plats[index];
  document.getElementById("modal-plat").style.display="block";
  document.getElementById("p-nom").value=plat.Nom;
  const list=document.getElementById("ingredients-list");
  list.innerHTML="";
  getFoods().forEach((i,idx)=>{
    const existing=plat.ingredients.find(ing=>ing.Nom===i.Nom);
    const checked=existing?"checked":"";
    const qtyVal=existing?existing.Quantite:"";
    const div=document.createElement("div");
    div.className="row";
    div.innerHTML=`<input type="checkbox" data-index="${idx}" ${checked}/> ${i.Nom}
    <input type="number" placeholder="g" style="width:60px" data-index="${idx}" value="${qtyVal}">`;
    list.appendChild(div);
  });
  document.getElementById("btn-save-plat").onclick=()=>{
    const nom=document.getElementById("p-nom").value.trim();
    if(!nom){alert("Nom du plat requis");return;}
    const checkboxes=document.querySelectorAll("#ingredients-list input[type=checkbox]");
    let ingredients=[];
    checkboxes.forEach(cb=>{
      if(cb.checked){
        const idx=parseInt(cb.dataset.index);
        const qtyInput=document.querySelector(`#ingredients-list input[type=number][data-index='${idx}']`);
        const qty=parseFloat(qtyInput.value)||0;
        if(qty>0){
          const f=getFoods()[idx];
          ingredients.push({Nom:f.Nom,Proteines:f.Proteines,Glucides:f.Glucides,Lipides:f.Lipides,Calories:f.Calories,Quantite:qty});
        }
      }
    });
    let totalProt=0,totalCarb=0,totalFat=0,totalCal=0;
    ingredients.forEach(i=>{
      const ratio=i.Quantite/100;
      totalProt+=i.Proteines*ratio;
      totalCarb+=i.Glucides*ratio;
      totalFat+=i.Lipides*ratio;
      totalCal+=i.Calories*ratio;
    });
    plats[index]={Nom:nom,ingredients,totalProt,totalCarb,totalFat,totalCal};
    savePlats(plats);
    document.getElementById("modal-plat").style.display="none";
    document.getElementById("p-nom").value="";
    computeTotals();
  };
}
function supprimerPlat(index){
  if(!confirm("Supprimer ce plat ?")) return;
  let plats=getPlats();
  plats.splice(index,1);
  savePlats(plats);
  computeTotals();
}

// ajout aliment
document.getElementById("btn-add").addEventListener("click",()=>{
  const nom=document.getElementById("f-nom").value.trim();
  const prot=parseFloat(document.getElementById("f-prot").value);
  const carb=parseFloat(document.getElementById("f-carb").value);
  const fat=parseFloat(document.getElementById("f-fat").value);
  const kcal=parseFloat(document.getElementById("f-kcal").value);
  const cat=document.getElementById("f-cat").value||"prot";
  if(!nom||[prot,carb,fat,kcal].some(v=>isNaN(v))){
    alert("Complète tous les champs");return;
  }
  const custom=getFoods();
  custom.push({Nom:nom,Proteines:prot,Glucides:carb,Lipides:fat,Calories:kcal,Categorie:cat});
  saveFoods(custom);
  ["f-nom","f-prot","f-carb","f-fat","f-kcal"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("f-cat").value="prot";
  renderTable();
});
document.getElementById("btn-clear-custom").addEventListener("click",()=>{
  if(confirm("Supprimer tous tes aliments personnalisés ?")){
    localStorage.removeItem(LS_CUSTOM);
    renderTable();
  }
});

renderTable();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Suivi Calories & Macros - Plats interactifs</title>
    <style>
        :root { --bg:#0f172a; --card:#111827; --muted:#6b7280; --text:#e5e7eb; --accent:#22c55e; }
        *{box-sizing:border-box}
        body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:var(--bg); color:var(--text)}
        .wrap{max-width:960px; margin:0 auto; padding:24px}
        .card{background:var(--card); border:1px solid #1f2937; border-radius:18px; padding:18px; box-shadow:0 10px 20px rgba(0,0,0,.25)}
        h1{margin:0 0 8px; font-size:26px}
        p.helper{margin:0 0 16px; color:var(--muted); font-size:14px}
        .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
        input[type="text"], input[type="number"], button, select{height:40px; border-radius:10px; border:1px solid #374151; background:#0b1220; color:var(--text); padding:0 12px}
        input[type="number"]{width:90px}
        button{cursor:pointer}
        button.primary{background:#0b3b22; border-color:#1f5134}
        button.danger{background:#3b0b0b; border-color:#512121}
        table{width:100%; border-collapse:separate; border-spacing:0; margin-top:12px; display:block; overflow-x:auto;}
        th,td{border-bottom:1px solid #1f2937; padding:10px; text-align:center; font-size:14px}
        thead th{position:sticky; top:0; background:#0b1220; z-index:1}
        tbody tr:hover{background:#0b1220}
        tbody tr {
            transition: all 0.25s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            margin-bottom: 8px;
            border-radius: 10px;
        }
        tbody tr:hover {
            background: #111827;
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.22);
        }
        .card, .modal-content {
            transition: all 0.3s ease;
        }
        .fade-in {
            animation: fadeIn 0.45s ease forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-6px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .totals{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:16px}
        .stat{background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:12px; text-align:center}
        .stat b{display:block; font-size:18px}
        details{margin-top:14px}
        details summary{cursor:pointer; color:#a7f3d0}
        .actions{display:flex; gap:10px; margin-top:20px; flex-wrap:wrap}
        .actions button{flex:1}

        .bar-container { background:#1f2937; border-radius:10px; height:20px; width:100%; margin:5px 0; overflow:hidden; position:relative; }
        .bar {
            height:100%;
            border-radius:10px;
            text-align:right;
            padding-right:8px;
            color:white;
            font-size:12px;
            transition: width 0.7s cubic-bezier(.2,.9,.2,1);
            width:0%;
            box-sizing:border-box;
            white-space:nowrap;
        }
        .bar.prot  { background:#3b82f6; }
        .bar.carb  { background:#f97316; }
        .bar.fat   { background:#a855f7; }
        .bar.cal   { background:#22c55e; }
        .bar.over { box-shadow: 0 0 0 2px rgba(220,38,38,0.12); }

        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); overflow:auto; z-index: 1000 }
        .modal-content { background:#111827; margin:5% auto; padding:20px; width:90%; max-width:700px; border-radius:10px; color:var(--text); position : relative; z-index: 1001;}
        .close { float:right; cursor:pointer; font-size:20px; }
        .tabs{display:flex; gap:10px; margin-bottom:12px;}
        .tab-btn{flex:1; padding:10px; cursor:pointer; border:none; border-radius:10px; background:#1f2937; color:var(--text)}
        .tab-btn.active{background:var(--accent); color:#0f172a}

        @media (max-width:640px){ 
            h1{font-size:22px} 
            input[type="number"]{width:80px} 
            .totals{grid-template-columns:1fr;} 
        }
        @media (max-width:640px){
            table, thead, tbody, th, td, tr {
                display: block;
            }
            thead { display: none; }
            tbody tr {
                margin-bottom: 12px;
                background: #0b1220;
                padding: 12px;
                border-radius: 12px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.18);
            }
            tbody td {
                display: flex;
                justify-content: space-between;
                padding: 6px 0;
                border: none;
                font-size: 14px;
            }
            tbody td::before {
                content: attr(data-label);
                font-weight: bold;
                color: var(--muted);
                margin-right: 8px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="wrap">
    <div class="card">
        <h1>Suivi Calories & Macros</h1>
        <p class="helper">Tout est <b>par 100 g</b>. Saisis la quantit√© pour chaque aliment ou plat.</p>

        <div class="tabs">
            <button class="tab-btn active" data-tab="ingredients">Ingr√©dients</button>
            <button class="tab-btn" data-tab="plats">Plats</button>
        </div>

        <div id="tab-ingredients" class="tab-content">
            <div class="row" style="margin-bottom:8px">
                <input id="q" type="text" placeholder="Rechercher un aliment‚Ä¶" />
            </div>
            <details>
                <summary>‚ûï Ajouter un aliment personnalis√©</summary>
                <div class="row" style="margin-top:10px">
                    <input id="f-nom" type="text" placeholder="Nom (ex: Fromage blanc 0%)" style="flex:1" />
                    <input id="f-prot" type="number" step="0.1" placeholder="Prot /100g" />
                    <input id="f-carb" type="number" step="0.1" placeholder="Gluc /100g" />
                    <input id="f-fat"  type="number" step="0.1" placeholder="Lip /100g" />
                    <input id="f-kcal" type="number" step="1"   placeholder="Kcal /100g" />
                    <select id="f-cat">
                      <option value="prot">ü•© Prot√©ine</option>
                      <option value="carb">üçö Glucide</option>
                      <option value="fat">ü•ë Lipide</option>
                    </select>
                    <button id="btn-add" class="primary">Ajouter</button>
                    <button id="btn-clear-custom" class="danger">Vider persos</button>
                </div>
            </details>
            <div class="row" style="margin-bottom:10px; align-items:center;">
              <label>Filtrer par cat√©gorie : </label>
              <select id="filter-cat">
                <option value="">Toutes</option>
                <option value="prot">ü•© Prot√©ines</option>
                <option value="carb">üçö Glucides</option>
                <option value="fat">ü•ë Lipides</option>
              </select>
            </div>
            <table id="tbl">
                <thead>
                <tr>
                    <th style="text-align:left">Aliment</th>
                    <th>Prot (/100g)</th>
                    <th>Gluc (/100g)</th>
                    <th>Lip (/100g)</th>
                    <th>Kcal (/100g)</th>
                    <th>Cat√©gorie</th>
                    <th>Quantit√© (g)</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="tab-plats" class="tab-content" style="display:none;">
            <div class="row" style="margin-bottom:8px">
                <input id="p-nom" type="text" placeholder="Nom du plat‚Ä¶" style="flex:1" />
                <button id="btn-add-plat" class="primary">Ajouter plat</button>
            </div>
            <table id="tbl-plats">
                <thead>
                <tr>
                    <th style="text-align:left">Plat</th>
                    <th>Prot</th>
                    <th>Gluc</th>
                    <th>Lip</th>
                    <th>Kcal</th>
                    <th>Quantit√© (portion)</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="totals">
            <div class="stat"><span>Prot√©ines totales</span><b id="t-prot" data-value="0">0 g</b>
                <div class="bar-container" onclick="ouvrirGraph('prot')"><div id="barProt" class="bar prot"></div></div></div>
            <div class="stat"><span>Glucides totaux</span><b id="t-carb" data-value="0">0 g</b>
                <div class="bar-container" onclick="ouvrirGraph('carb')"><div id="barCarb" class="bar carb"></div></div></div>
            <div class="stat"><span>Lipides totaux</span><b id="t-fat" data-value="0">0 g</b>
                <div class="bar-container" onclick="ouvrirGraph('fat')"><div id="barFat" class="bar fat"></div></div></div>
            <div class="stat"><span>Calories totales</span><b id="t-kcal" data-value="0">0 kcal</b>
                <div class="bar-container" onclick="ouvrirGraph('cal')"><div id="barCal" class="bar cal"></div></div></div>
        </div>

        <div class="actions">
            <button class="primary" onclick="sauvegarderJournee()">üíæ Sauvegarder la journ√©e</button>
            <button class="danger" onclick="nouvelleJournee()">üîÑ Nouvelle journ√©e</button>
            <button onclick="ouvrirObjModal()">‚öôÔ∏è Modifier objectifs</button>
        </div>
    </div>
</div>

<div id="modal-plat" class="modal">
    <div class="modal-content">
        <span class="close" onclick="document.getElementById('modal-plat').style.display='none'">&times;</span>
        <h3>Cr√©er un plat</h3>
        <div style="margin-bottom:8px; display:flex; gap:8px; flex-wrap:wrap;">
          <input id="ing-search" type="text" placeholder="Rechercher un aliment‚Ä¶" style="flex:1"/>
          <select id="ing-filter">
            <option value="">Toutes</option>
            <option value="prot">ü•© Prot√©ines</option>
            <option value="carb">üçö Glucides</option>
            <option value="fat">ü•ë Lipides</option>
          </select>
        </div>
        <div id="ingredients-list" style="max-height:400px;overflow:auto"></div>
        <button id="btn-save-plat" class="primary" style="margin-top:10px">Valider le plat</button>
    </div>
</div>

<div id="graphModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fermerGraph()">&times;</span>
        <canvas id="graphCanvas"></canvas>
    </div>
</div>

<div id="objModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="fermerObjModal()">&times;</span>
    <h3>Modifier mes objectifs</h3>
    <div class="row" style="flex-direction:column; gap:8px; margin-top:10px">
      <label>Prot√©ines (g) <input type="number" id="obj-prot"></label>
      <label>Glucides (g) <input type="number" id="obj-carb"></label>
      <label>Lipides (g) <input type="number" id="obj-fat"></label>
      <label>Calories (kcal) <input type="number" id="obj-cal"></label>
    </div>
    <button class="primary" style="margin-top:12px" onclick="sauverObj()">‚úÖ Sauvegarder</button>
  </div>
</div>

<script>
/* ==== JS COMPLET AVEC GESTION DES PLATS ET ALIMENTS ==== */
let defaultAliments = [
  {nom:"Poulet", prot:31, carb:0, lip:3.6, kcal:165, cat:"prot"},
  {nom:"Riz", prot:2.7, carb:28, lip:0.3, kcal:130, cat:"carb"},
  {nom:"Avocat", prot:2, carb:9, lip:15, kcal:160, cat:"fat"}
];
let LS_CUSTOM = JSON.parse(localStorage.getItem("custom")) || [];
let LS_QTY = JSON.parse(localStorage.getItem("qty")) || {};
let LS_PLATS = JSON.parse(localStorage.getItem("plats")) || [];
let objectifs = JSON.parse(localStorage.getItem("obj")) || {prot:150, carb:200, fat:60, cal:2200};

function saveCustom(){ localStorage.setItem("custom",JSON.stringify(LS_CUSTOM)) }
function saveQty(){ localStorage.setItem("qty",JSON.stringify(LS_QTY)) }
function savePlats(){ localStorage.setItem("plats",JSON.stringify(LS_PLATS)) }
function saveObj(){ localStorage.setItem("obj",JSON.stringify(objectifs)) }

function renderTable(){
  let tbody = document.querySelector("#tbl tbody");
  let filter = document.getElementById("filter-cat").value;
  let search = document.getElementById("q").value.toLowerCase();
  tbody.innerHTML="";
  [...defaultAliments,...LS_CUSTOM].forEach((a,i)=>{
    if(filter && a.cat!==filter) return;
    if(search && !a.nom.toLowerCase().includes(search)) return;
    let tr = document.createElement("tr");
    tr.classList.add("fade-in");
    tr.innerHTML=`
      <td data-label="Aliment">${a.nom}</td>
      <td data-label="Prot">${a.prot}</td>
      <td data-label="Gluc">${a.carb}</td>
      <td data-label="Lip">${a.lip}</td>
      <td data-label="Kcal">${a.kcal}</td>
      <td data-label="Cat">${a.cat}</td>
      <td data-label="Quantit√©"><input type="number" min="0" value="${LS_QTY[a.nom]||0}" onchange="setQty('${a.nom}',this.value)"></td>
      <td data-label="Actions"><button onclick="delAliment('${a.nom}')">üóëÔ∏è</button></td>
    `;
    tbody.appendChild(tr);
  });
  calcTotals();
}

function setQty(nom,val){
  LS_QTY[nom]=parseFloat(val)||0;
  saveQty();
  calcTotals();
}

function delAliment(nom){
  LS_CUSTOM = LS_CUSTOM.filter(a=>a.nom!==nom);
  delete LS_QTY[nom];
  saveCustom();
  saveQty();
  renderTable();
}

document.getElementById("btn-add").onclick = ()=>{
  let nom=document.getElementById("f-nom").value.trim();
  let prot=parseFloat(document.getElementById("f-prot").value)||0;
  let carb=parseFloat(document.getElementById("f-carb").value)||0;
  let lip=parseFloat(document.getElementById("f-fat").value)||0;
  let kcal=parseFloat(document.getElementById("f-kcal").value)||0;
  let cat=document.getElementById("f-cat").value;
  if(nom){ LS_CUSTOM.push({nom,prot,carb,lip,kcal,cat}); saveCustom(); renderTable(); }
}

document.getElementById("btn-clear-custom").onclick = ()=>{
  LS_CUSTOM=[]; saveCustom(); renderTable();
}

document.getElementById("q").oninput = renderTable;
document.getElementById("filter-cat").onchange = renderTable;

function calcTotals(){
  let tot={prot:0,carb:0,lip:0,cal:0};
  [...defaultAliments,...LS_CUSTOM].forEach(a=>{
    let q = LS_QTY[a.nom]||0;
    tot.prot += a.prot*q/100;
    tot.carb += a.carb*q/100;
    tot.lip += a.lip*q/100;
    tot.cal += a.kcal*q/100;
  });
  ["prot","carb","lip","cal"].forEach(key=>{
    let val = tot[key]; 
    document.getElementById("t-"+key).textContent = key==="cal"?Math.round(val)+" kcal":Math.round(val)+" g";
    let bar = document.getElementById("bar"+key.charAt(0).toUpperCase()+key.slice(1));
    let pct = Math.min(100,val/objectifs[key]*100);
    bar.style.width = pct+"%";
    bar.classList.toggle("over",val>objectifs[key]);
  });
}

/* ==== PLATS ==== */
function renderPlats(){
  let tbody = document.querySelector("#tbl-plats tbody");
  tbody.innerHTML="";
  LS_PLATS.forEach((p,i)=>{
    let tr=document.createElement("tr");
    tr.classList.add("fade-in");
    let tot={prot:0,carb:0,lip:0,cal:0};
    p.ingredients.forEach(({nom,q})=>{
      let a = [...defaultAliments,...LS_CUSTOM].find(x=>x.nom===nom);
      if(a){ tot.prot+=a.prot*q/100; tot.carb+=a.carb*q/100; tot.lip+=a.lip*q/100; tot.cal+=a.kcal*q/100; }
    });
    tr.innerHTML=`
      <td data-label="Plat">${p.nom}</td>
      <td data-label="Prot">${Math.round(tot.prot)}</td>
      <td data-label="Gluc">${Math.round(tot.carb)}</td>
      <td data-label="Lip">${Math.round(tot.lip)}</td>
      <td data-label="Kcal">${Math.round(tot.cal)}</td>
      <td data-label="Quantit√©"><input type="number" min="0" value="${p.qty||0}" onchange="setPlatQty(${i},this.value)"></td>
      <td data-label="Actions">
        <button onclick="delPlat(${i})">üóëÔ∏è</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function setPlatQty(i,val){ LS_PLATS[i].qty=parseFloat(val)||0; savePlats(); calcTotals(); }
function delPlat(i){ LS_PLATS.splice(i,1); savePlats(); renderPlats(); }

/* ==== MODAL PLAT ==== */
let platModal = document.getElementById("modal-plat");
document.getElementById("btn-add-plat").onclick = ()=>{ platModal.style.display="block"; renderIngredientsList(); }

function renderIngredientsList(){
  let list=document.getElementById("ingredients-list"); list.innerHTML="";
  let filter=document.getElementById("ing-filter").value;
  let search=document.getElementById("ing-search").value.toLowerCase();
  [...defaultAliments,...LS_CUSTOM].forEach(a=>{
    if(filter && a.cat!==filter) return;
    if(search && !a.nom.toLowerCase().includes(search)) return;
    let div=document.createElement("div");
    div.classList.add("row");
    div.innerHTML=`<input type="checkbox" data-nom="${a.nom}"/> ${a.nom} <input type="number" value="100" min="1" style="width:60px"/> g`;
    list.appendChild(div);
  });
}

document.getElementById("ing-search").oninput = renderIngredientsList;
document.getElementById("ing-filter").onchange = renderIngredientsList;

document.getElementById("btn-save-plat").onclick = ()=>{
  let nom = document.getElementById("p-nom").value.trim();
  if(!nom) return;
  let ingredients=[];
  document.querySelectorAll("#ingredients-list .row").forEach(r=>{
    let cb = r.querySelector("input[type=checkbox]");
    let qty = parseFloat(r.querySelector("input[type=number]").value)||0;
    if(cb.checked) ingredients.push({nom:cb.dataset.nom,q:qty});
  });
  if(ingredients.length>0){ LS_PLATS.push({nom,ingredients,qty:0}); savePlats(); renderPlats(); }
  platModal.style.display="none";
  document.getElementById("p-nom").value="";
}

/* ==== GRAPH ==== */
let graphModal = document.getElementById("graphModal");
let chart=null;
function ouvrirGraph(type){
  graphModal.style.display="block";
  let ctx = document.getElementById("graphCanvas").getContext("2d");
  let labels=[],data=[];
  [...defaultAliments,...LS_CUSTOM].forEach(a=>{
    let q = LS_QTY[a.nom]||0;
    if(q>0){ labels.push(a.nom); if(type==="prot") data.push(a.prot*q/100); else if(type==="carb") data.push(a.carb*q/100); else if(type==="lip") data.push(a.lip*q/100); else data.push(a.kcal*q/100);}
  });
  if(chart) chart.destroy();
  chart = new Chart(ctx,{type:'bar',data:{labels, datasets:[{label:type.toUpperCase(),data,backgroundColor:'#22c55e'}]}, options:{responsive:true,plugins:{legend:{display:false}}}});
}
function fermerGraph(){ graphModal.style.display="none"; }

/* ==== OBJECTIFS ==== */
function ouvrirObjModal(){
  document.getElementById("obj-prot").value = objectifs.prot;
  document.getElementById("obj-carb").value = objectifs.carb;
  document.getElementById("obj-fat").value = objectifs.fat;
  document.getElementById("obj-cal").value = objectifs.cal;
  document.getElementById("objModal").style.display="block";
}
function fermerObjModal(){ document.getElementById("objModal").style.display="none"; }
function sauverObj(){
  objectifs.prot=parseFloat(document.getElementById("obj-prot").value)||150;
  objectifs.carb=parseFloat(document.getElementById("obj-carb").value)||200;
  objectifs.fat=parseFloat(document.getElementById("obj-fat").value)||60;
  objectifs.cal=parseFloat(document.getElementById("obj-cal").value)||2200;
  saveObj(); calcTotals(); fermerObjModal();
}

/* ==== TABS ==== */
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll(".tab-content").forEach(c=>c.style.display="none");
    document.getElementById("tab-"+btn.dataset.tab).style.display="block";
  }
});

/* ==== INIT ==== */
renderTable();
renderPlats();

/* ==== JOURNEE ==== */
function sauvegarderJournee(){ localStorage.setItem("journee",JSON.stringify({qty:LS_QTY,plats:LS_PLATS})); alert("Journ√©e sauvegard√©e !"); }
function nouvelleJournee(){ LS_QTY={}; LS_PLATS=[]; saveQty(); savePlats(); renderTable(); renderPlats(); }
</script>
</body>
</html>
